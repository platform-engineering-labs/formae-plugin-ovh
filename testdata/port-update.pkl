/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "@ovh/ovh.pkl"

import "@ovh/network/network.pkl"
import "@ovh/network/port.pkl"

local stackName = "plugin-sdk-test-stack"
// Read the test run ID from environment variable set by the test harness
// This ensures consistent naming within a test run but unique names between runs
local testRunID = read("env:FORMAE_TEST_RUN_ID")

forma {
  new formae.Stack {
    label = stackName
    description = "Plugin SDK test for OVH Port - Update"
  }

  new formae.Target {
    label = "ovh-target"
    config = new ovh.Config {
      authURL = "https://auth.cloud.ovh.us/v3"
      region = "US-EAST-VA-1"
      // username, password, projectID, domainName will be read from environment variables:
      // OS_USERNAME, OS_PASSWORD, OS_PROJECT_ID, OS_USER_DOMAIN_NAME
    }
  }

  // Define the network that this port belongs to (same as in port.pkl)
  local testNetwork = new network.Network {
    label = "plugin-sdk-test-network"
    name = "formae-plugin-sdk-test-network-\(testRunID)"
    description = "Test network for port plugin SDK tests"
    admin_state_up = true
  }
  testNetwork

  // Update the port - change mutable properties
  // Note: description is CreateOnly on OVH, so we keep it unchanged
  new port.Port {
    label = "plugin-sdk-test-port"
    name = "formae-plugin-sdk-test-port-\(testRunID)-updated"
    description = "Test port for plugin SDK tests"  // Same as original (CreateOnly)
    network_id = testNetwork.res.id
    admin_state_up = false  // Changed admin state
    allowed_address_pairs {
      new port.AddressPair {
        ip_address = "10.0.0.100"
      }
      new port.AddressPair {
        ip_address = "10.0.0.101"  // Added additional address pair in update
      }
    }
    tags {
      "env:test"
      "managed-by:formae"
      "updated:true"  // New tag added in update
    }
  }
}
