/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"

import "@ovh/network/network.pkl"
import "@ovh/network/subnet.pkl"

import "./vars.pkl" as v

forma {
  v.stack
  v.target

  // Create a network with an initial embedded subnet
  local testNetwork = new network.Network {
    label = "plugin-sdk-test-network"
    name = "formae-plugin-sdk-test-network-\(v.testRunID)"
    subnet = new network.SubnetConfig {
      cidr = "10.0.0.0/24"
      ipVersion = 4
      enableDhcp = true
      enableGatewayIp = true
      name = "formae-plugin-sdk-test-initial-subnet-\(v.testRunID)"
    }
  }
  testNetwork

  // Create an additional subnet under the existing network
  // Uses POST /cloud/project/{serviceName}/region/{regionName}/network/{networkId}/subnet
  new subnet.Subnet {
    label = "plugin-sdk-test-subnet"
    network_id = testNetwork.res.id
    name = "formae-plugin-sdk-test-subnet-\(v.testRunID)"
    cidr = "10.0.1.0/24"
    ipVersion = 4
    enableDhcp = true
    enableGatewayIp = true
    dnsNameServers {
      "8.8.8.8"
      "8.8.4.4"
    }
  }
}
