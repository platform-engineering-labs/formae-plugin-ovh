/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"

import "./vars.pkl" as v

import "@ovh/network/securitygroup.pkl"
import "@ovh/network/securitygrouprule.pkl"

forma {
  v.stack
  v.target

  // Parent security group (dependency)
  local testSecurityGroup = new securitygroup.SecurityGroup {
    label = "plugin-sdk-test-sg-for-rule"
    name = "formae-plugin-sdk-test-sg-for-rule-\(v.testRunID)"
    description = "Security group for rule tests"
  }
  testSecurityGroup

  // The security group rule under test - changing a createOnly field triggers replacement
  // This changes port_range_min/max which are createOnly fields
  new securitygrouprule.SecurityGroupRule {
    label = "plugin-sdk-test-rule"
    security_group_id = testSecurityGroup.res.id
    direction = "ingress"
    ethertype = "IPv4"
    protocol = "tcp"
    port_range_min = 9090  // Changed from 8080 - triggers delete + create
    port_range_max = 9090  // Changed from 8080 - triggers delete + create
    remote_ip_prefix = "0.0.0.0/0"
    description = "Replaced rule with different port (createOnly change)"
  }
}
