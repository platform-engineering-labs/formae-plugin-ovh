/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "@ovh/ovh.pkl"

import "@ovh/compute/instance.pkl"
import "@ovh/compute/keypair.pkl"

local stackName = "plugin-sdk-test-stack"
// Read the test run ID from environment variable set by the test harness
// This ensures consistent naming within a test run but unique names between runs
local testRunID = read("env:FORMAE_TEST_RUN_ID")

// OVH-provided resource IDs (these are pre-existing in the OVH environment)
// Ext-Net is the public network provided by OVH for external connectivity
local extNetID = "b347ed75-8603-4ce0-a40c-c6c98a8820fc"
// Ubuntu 24.04 image provided by OVH
local ubuntuImageID = "03302136-e20b-446e-8b27-cf0aaf161810"
// s1-2 flavor (2GB RAM, 1 vCPU)
local flavorID = "a64381e7-c4e7-4b01-9fbe-da405c544d2e"

forma {
  new formae.Stack {
    label = stackName
    description = "Plugin SDK test for OVH Instance"
  }

  new formae.Target {
    label = "ovh-target"
    config = new ovh.Config {
      authURL = "https://auth.cloud.ovh.us/v3"
      region = "US-EAST-VA-1"
      // username, password, projectID, domainName will be read from environment variables:
      // OS_USERNAME, OS_PASSWORD, OS_PROJECT_ID, OS_USER_DOMAIN_NAME
    }
  }

  // Keypair for SSH access - tests key_name field on Instance
  local testKeypair = new keypair.Keypair {
    label = "plugin-sdk-test-keypair"
    name = "formae-plugin-sdk-test-keypair-\(testRunID)"
    // Use a valid test public key (2048-bit RSA - this is a throwaway key for testing only)
    publicKey = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDRw/Zmg9JzQOf2RkXpZ0LEYrinbONmjU2dFOITi8dtvrBj2irZiW2Adwq8rJqYPUIUrOHmb/fn4QSJB+dwJwARr0YkS63lHsVqxUV7WNx2+VD1YwcrJ5mQFteLqGerYMjK6OxaB8270xEJP8DE9mv3uG3BbTE4I/N65YDQq3WS+4ejn4uRzEeu+CGiwMwmsYMB8qD5Qsw41y7d3neF/1cfauC+wmJ9RNPgLDLJ0w/IgFXaV9S9tXpoaf7U5M0JsK1J4mGO4w7t0xUpznlyRJQydai4OGOR+jTOnVtz1exg5E3Yyk/4iWdZo0BoXKg3Yx0GGKTo22UildvfjkOOHUs9 formae-test"
  }
  testKeypair

  // Simple instance test - only use the public network (Ext-Net)
  // This tests basic instance lifecycle without complex network dependencies
  // The Port resource and network dependency ordering are tested separately
  new instance.Instance {
    label = "plugin-sdk-test-instance"
    name = "formae-plugin-sdk-test-\(testRunID)"
    flavor_id = flavorID
    image_id = ubuntuImageID
    // Reference the keypair name - tests key_name functionality
    // Note: Keypair will be created first due to resource ordering in forma
    key_name = testKeypair.name
    networks = new Listing {
      // Public network (Ext-Net) - pre-existing OVH resource
      new instance.NetworkAttachment {
        uuid = extNetID
      }
    }
    metadata = new Mapping {
      ["environment"] = "test"
      ["managed_by"] = "formae"
    }
  }
}
