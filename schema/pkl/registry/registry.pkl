/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

/// OVH Managed Private Registry (Harbor)
/// API: POST /cloud/project/{serviceName}/containerRegistry
module ovh.registry.registry

import "@formae/formae.pkl"
import "../ovh.pkl"

const type = "OVH::Registry::Registry"

/// Registry status
typealias RegistryStatus = "INSTALLING"|"UPDATING"|"RESTORING"|"SUSPENDING"|"SUSPENDED"|"DELETING"|"ERROR"|"READY"

/// Registry plan codes
/// - SMALL: Entry level
/// - MEDIUM: Medium capacity
/// - LARGE: Large capacity
typealias PlanCode = "SMALL"|"MEDIUM"|"LARGE"

/// Resolvable reference to a Container Registry
open class RegistryResolvable extends formae.Resolvable {
  hidden type = module.type

  hidden id: RegistryResolvable = (this) { property = "id" }

  hidden url: RegistryResolvable = (this) { property = "url" }
}

@ovh.ResourceHint {
  type = module.type
  identifier = "id"
}
open class Registry extends formae.Resource {
  hidden parent = this

  /// Cloud project service name (project ID)
  @ovh.FieldHint { required = true; createOnly = true }
  serviceName: String

  /// Registry name
  @ovh.FieldHint { required = true }
  name: String

  /// Region where the registry is deployed
  @ovh.FieldHint { required = true; createOnly = true }
  region: String

  /// Plan ID (use capabilities API to get available plans)
  /// Can be upgraded but not downgraded
  planId: String?

  // === Computed/Output fields ===

  /// Registry ID
  @ovh.FieldHint { persist = false }
  id: String?

  /// Registry status
  @ovh.FieldHint { persist = false }
  status: RegistryStatus?

  /// Registry URL (e.g., "xxxxxx.gra7.container-registry.ovh.net")
  @ovh.FieldHint { persist = false }
  url: String?

  /// Harbor version
  @ovh.FieldHint { persist = false }
  version: String?

  /// Current storage size in bytes
  @ovh.FieldHint { persist = false }
  size: Int?

  /// Whether IAM is enabled
  @ovh.FieldHint { persist = false }
  iamEnabled: Boolean?

  /// Creation timestamp
  @ovh.FieldHint { persist = false }
  createdAt: String?

  /// Last update timestamp
  @ovh.FieldHint { persist = false }
  updatedAt: String?

  hidden res: RegistryResolvable = new {
    label = parent.label
    stack = parent.stack?.label
  }
}
